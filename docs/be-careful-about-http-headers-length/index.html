<!doctype html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>Be careful about HTTP headers length</title><meta content="Investigation of a bug caused by trying to cram too much CSP settings into HTTP headers." name="description"><meta content="Be careful about HTTP headers length" property="og:title"><meta content="Investigation of a bug caused by trying to cram too much CSP settings into HTTP headers." property="og:description"><meta content="article" property="og:type"><style>body,html{margin:0 0}body{color:#222;font-size:18px;line-height:1.5}.header-content,article,footer{margin:0 auto;padding:0 15px;max-width:710px}h1{border-bottom:2px solid #ffd744;padding-bottom:15px;font-size:32px}.blog-name{text-align:center;padding-bottom:25px}h2{font-size:24px}h3{font-size:20px}a{text-decoration:none;color:#927200;transition:color .25s ease-out}a:hover{color:#bb9200}code{font-size:14px}pre{overflow:auto}img{max-width:100%}.footer-content{margin-top:15px;border-top:2px solid #ffd744;padding-top:15px;padding-bottom:15px}.art-list-link{font-size:22px;margin-bottom:5px}.art-list-link a{color:#222;transition:color .2s ease-out}.art-list-link a:hover{color:#555}.art-list-date{font-size:16px}@media (prefers-color-scheme:dark){body{background:#222;color:#fff}a{color:#ffd744}a:hover{color:#bb9200}.art-list-link a{color:#fff}.art-list-link a:hover{color:#eee}}@media (min-width:768px){body{font-size:20px}code{font-size:16px}}</style><link href="/img/favicon.svg" rel="icon" type="image/svg+xml"><link href="/img/favicon.ico" rel="alternate icon"></head><body><article><h1>Be careful about HTTP headers length</h1><p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP">Content Security Policy (CSP)</a> settings help improving website security by allowing usage of resources only from specified origins. For example, it's possible to prevent the website from executing scripts not coming from our server, or prevent performing HTTP requests to addresses other than ours. When a website communicates with external services, for example analytics services, customer chat or login providers, allowing communications with these services while still preventing connection to other services requires adding these services to the CSP settings.</p><p>CSP settings are sent to the browser in the HTTP headers.</p><h2>The problem and investigation</h2><p>Recently, we had an issue when trying to deploy a newer version of a website on Google App Engine. The deployment failed with the following error message:</p><pre><code>Your deployment has failed to become healthy in the allotted time and therefore was rolled back. If you believe this was an error, try adjusting the 'app_start_timeout_sec' setting in the 'readiness_check' section.
</code></pre><p>The error message indicates that the deployment failed to start within the time limit. Google App Engine checks if the deployment is healthy by sending a request to the website and checking if the response is successful. If the response is not successful, the deployment is rolled back.</p><p>When checking logs in the Google Cloud logs viewer, in the logs of nginx (not in the logs of application), we found the following error message:</p><pre><code>upstream sent too big header while reading response header from upstream
</code></pre><p>This error message indicates that the response headers from the application are too long.</p><p>Reviewing changes between the deployed versions, we found that we added a new external service to the CSP settings. This caused the CSP header, and thus the response headers, to be longer than before, exceeding the limit.</p><h2>Potential solutions</h2><p>If you see that the CSP settings cause your HTTP headers to be too long, you can try the following solutions:</p><ol><li>Check if you don't have no longer used external services in the CSP settings.</li><li>Shorten the CSP settings by removing <code>https://</code> from the URLs.</li><li>Shorten the CSP settings by merging URLs with multiple subdomains into one, for example <code>aaa.example.com</code> and <code>bbb.example.com</code> can be merged into <code>*.example.com</code>.</li><li>Check if you actually need to use some external service.</li></ol><p>This way, it's possible to allow intentional connections to external services while still preventing attackers from connecting to arbitrary external servers and executing arbitrary scripts on the website.</p><a href="/">Go back to home page</a></article><footer><div class="footer-content"><a href="https://www.radcode.co/">Do you need an app?</a></div></footer><link href="/styles/prism-atom-dark.css" rel="stylesheet"></body></html>