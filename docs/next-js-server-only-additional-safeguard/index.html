<!doctype html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>Additional security safeguard for server-only files in Next.js</title><meta content="How to prevent sending server-only code to the browser in Next.js" name="description"><style>body,html{margin:0 0}body{color:#222;font-size:18px;line-height:1.5}.header-content,article,footer{margin:0 auto;padding:0 15px;max-width:710px}h1{border-bottom:2px solid #ffd744;padding-bottom:15px;font-size:32px}.blog-name{text-align:center;padding-bottom:25px}h2{font-size:24px}h3{font-size:20px}a{text-decoration:none;color:#927200;transition:color .25s ease-out}a:hover{color:#bb9200}code{font-size:14px}pre{overflow:auto}img{max-width:100%}.footer-content{margin-top:15px;border-top:2px solid #ffd744;padding-top:15px;padding-bottom:15px}.art-list-link{font-size:22px;margin-bottom:5px}.art-list-link a{color:#222;transition:color .2s ease-out}.art-list-link a:hover{color:#555}.art-list-date{font-size:16px}@media (prefers-color-scheme:dark){body{background:#222;color:#fff}a{color:#ffd744}a:hover{color:#bb9200}.art-list-link a{color:#fff}.art-list-link a:hover{color:#eee}}@media (min-width:768px){body{font-size:20px}code{font-size:16px}}</style><link href="/img/favicon.svg" rel="icon" type="image/svg+xml"><link href="/img/favicon.ico" rel="alternate icon"></head><body><article><h1>Additional security safeguard for server-only files in Next.js</h1><h2>Problem and solution</h2><p>The problem is described in <a href="https://stackoverflow.com/questions/72119806/ensuring-sensitive-code-is-run-only-server-side-with-nextjs-where-can-such-code">this StackOverflow question</a>.</p><p>Next.js allows the same code to be ran on the server and in the browser. Code in <code>getStaticProps</code> and <code>getServerSideProps</code> will run on the server only, and when compiling the code to be sent to the browser, in <code>pages/...</code> files, Next automatically eliminates imports that are used only in the server-only functions.</p><p>But it may happen that code, that should be ran on server only, is accidentally included on the browser-side. This is a security risk. To mitigate a risk of leakage of some of the sensitive values, <a href="https://nextjs.org/docs/app/building-your-application/configuring/environment-variables#exposing-environment-variables-to-the-browser">Next.js environmental variables aren't exposed to the browser unless prefixed with <code>NEXT_PUBLIC_</code></a> - it's a part of the solution.</p><h2>Additional safeguard</h2><p>As an additional safeguard against exposing sensitive server-only code to the browser, it's possible to add a simple code snippet that will display an error if a server-only code gets imported on the client:</p><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span><br>  <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"--- SECURITY ERROR - Cannot import this file in the browser ---"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><p>This code should be added in the main scope of a file that should be run on the server only - a good place is immediately after imports.</p><h3>Example</h3><p>Let's consider a protected file named <code>sensitiveFunction.ts</code>:</p><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">!==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span><br>  <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">"--- SECURITY ERROR - Cannot import this file in the browser ---"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function function-variable">sensitiveFunction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"This should be ran on the server only!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> sensitiveFunction</code></pre><p>This page file will be displayed correctly, and it'll display the message <code>This should be ran on the server only!</code> on the console where Next.js is launched:</p><pre class="language-tsx"><code class="language-tsx"><span class="token comment">// ... other imports ...</span><br><span class="token keyword">import</span> sensitiveFunction <span class="token keyword">from</span> <span class="token string">"../utils/sensitiveFunction"</span><br><br><span class="token keyword">const</span> <span class="token function function-variable">SomePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> SomePage<span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function function-variable">getStaticProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><br>  <span class="token parameter">context</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">sensitiveFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;------ HERE</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><p>Displaying of this page file will cause the error to be visible in console.:</p><pre class="language-tsx"><code class="language-tsx"><span class="token comment">// ... other imports ...</span><br><span class="token keyword">import</span> sensitiveFunction <span class="token keyword">from</span> <span class="token string">"../utils/sensitiveFunction"</span><br><br><span class="token keyword">const</span> <span class="token function function-variable">SomePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token function">sensitiveFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// &lt;------ HERE</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span><span class="token comment">/* ... */</span><span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> SomePage<span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function function-variable">getStaticProps</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><br>  <span class="token parameter">context</span><br><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span> props<span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">/* ... */</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre><a href="/">Go back to home page</a></article><footer><div class="footer-content"><a href="https://www.radcode.co/">Do you need an app?</a></div></footer><link href="/styles/prism-atom-dark.css" rel="stylesheet"></body></html>