<!doctype html><html lang="en"><head><meta charset="utf-8"><meta content="width=device-width,initial-scale=1" name="viewport"><title>Next.js and FormatJS language namespacing</title><style>body,html{margin:0 0}body{color:#222;font-size:18px;line-height:1.5}.header-content,article,footer{margin:0 auto;padding:0 15px;max-width:710px}h1{border-bottom:2px solid #ffd744;padding-bottom:15px;font-size:32px}.blog-name{text-align:center;padding-bottom:25px}h2{font-size:24px}h3{font-size:20px}a{text-decoration:none;color:#927200;transition:color .25s ease-out}a:hover{color:#bb9200}code{font-size:14px}pre{overflow:auto}img{max-width:100%}.footer-content{margin-top:15px;border-top:2px solid #ffd744;padding-top:15px;padding-bottom:15px}.art-list-link{font-size:22px;margin-bottom:5px}.art-list-link a{color:#222;transition:color .2s ease-out}.art-list-link a:hover{color:#555}.art-list-date{font-size:16px}@media (prefers-color-scheme:dark){body{background:#222;color:#fff}a{color:#ffd744}a:hover{color:#bb9200}.art-list-link a{color:#fff}.art-list-link a:hover{color:#eee}}@media (min-width:768px){body{font-size:20px}code{font-size:16px}}</style><link href="/img/favicon.svg" rel="icon" type="image/svg+xml"><link href="/img/favicon.ico" rel="alternate icon"></head><body><article><h1>Next.js and FormatJS language namespacing</h1><p>As a part of my job, I work on a certain website using Next.js and FormatJS. As indicated by <a href="https://pagespeed.web.dev/">Pagespeed Insights</a>, file <code>_app.tsx</code> has lots of unused code andits size could be reduced to improve loading time and decrease data usage. Here's an optimization that reduces bundle size when using FormatJS and Next.js, especially for large websites.</p><h2>Problem</h2><p>When working with Next.js and FormatJS, most tutorials tells us to import JSON files with <a href="https://formatjs.io/docs/getting-started/message-distribution#compiling-messages">compiled</a> translations inside <code>_app.tsx</code> and pass the correct translation into, like that:</p><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> translationsPL <span class="token keyword">from</span> <span class="token string">"../locales/compiled/pl.json"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> translationsEN <span class="token keyword">from</span> <span class="token string">"../locales/compiled/en.json"</span><span class="token punctuation">;</span><br><span class="token comment">// ... other languages ...</span><br><br><span class="token keyword">function</span> <span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> Component<span class="token punctuation">,</span> pageProps <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">useRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">const</span> locale <span class="token operator">=</span> pageProps<span class="token punctuation">.</span>locale <span class="token operator">??</span> router<span class="token punctuation">.</span>locale<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> messages <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>locale<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token string">"pl"</span><span class="token operator">:</span><br>        <span class="token keyword">return</span> translationsPL<span class="token punctuation">;</span><br>      <span class="token keyword">case</span> <span class="token string">"en"</span><span class="token operator">:</span><br>        <span class="token keyword">return</span> translationsEN<span class="token punctuation">;</span><br>      <span class="token comment">// ... other languages ...</span><br>      <span class="token comment">// ...</span><br>      <span class="token comment">// ...</span><br>      <span class="token keyword">default</span><span class="token operator">:</span><br>        <span class="token keyword">return</span> translationPL<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>locale<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token punctuation">{</span><span class="token comment">/* ... other providers ... */</span><span class="token punctuation">}</span><br>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">IntlProvider</span></span> <span class="token attr-name">locale</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>locale<span class="token punctuation">}</span></span> <span class="token attr-name">messages</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>messages<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>        </span><span class="token punctuation">{</span><span class="token comment">/* ... other providers ... */</span><span class="token punctuation">}</span><span class="token plain-text"><br>          </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">Component</span></span> <span class="token spread"><span class="token punctuation">{</span><span class="token punctuation">...</span><span class="token attr-value">pageProps</span><span class="token punctuation">}</span></span> <span class="token punctuation">/></span></span><span class="token plain-text"><br>        </span><span class="token punctuation">{</span><span class="token comment">/* ... other providers ... */</span><span class="token punctuation">}</span><span class="token plain-text"><br>      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">IntlProvider</span></span><span class="token punctuation">></span></span><br>    <span class="token punctuation">{</span><span class="token comment">/* ... other providers ... */</span><span class="token punctuation">}</span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre><p>It works, but it's wasteful. It causes <strong>all</strong> translations to be loaded on <strong>every</strong> page. With lots of languages and lots of pages, it'll cause the downloaded JS size to significantly grow.</p><h2>Solution</h2><p>After trying several other ideas, I found a working solution:</p><ol><li>Make translations namespaced</li><li>Split messages into multiple files</li><li>Merge shared messages and namespaced translations and pass it into another IntlProvider</li></ol><h3>Make translations namespaced</h3><p>As we currently use explicit id for every translated text, for texts that are page-specific, not shared, we changed translation ids to format <code>[somenamespace]::[sometranslation]</code>. The separator is <code>::</code> but it could be actually any character or character sequence that doesn't otherwise exist in any existing translation id.</p><p>For example:</p><pre class="language-ts"><code class="language-ts">intl<span class="token punctuation">.</span><span class="token function">formatMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  id<span class="token operator">:</span> <span class="token string">"some-translation-id"</span><span class="token punctuation">,</span><br>  defaultMessage<span class="token operator">:</span> <span class="token string">"some text"</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>became:</p><pre class="language-ts"><code class="language-ts">intl<span class="token punctuation">.</span><span class="token function">formatMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  id<span class="token operator">:</span> <span class="token string">"mynamespace::some-translation-id"</span><span class="token punctuation">,</span><br>  defaultMessage<span class="token operator">:</span> <span class="token string">"some text"</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><p>and this:</p><pre class="language-tsx"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FormattedMessage</span></span><br>  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>some-translation-id-2<span class="token punctuation">"</span></span><br>  <span class="token attr-name">defaultMessage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>another text<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span></code></pre><p>became:</p><pre class="language-tsx"><code class="language-tsx"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">FormattedMessage</span></span><br>  <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>anothernamespace::some-translation-id-2<span class="token punctuation">"</span></span><br>  <span class="token attr-name">defaultMessage</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>another text<span class="token punctuation">"</span></span><br><span class="token punctuation">/></span></span></code></pre><p>Shared messages, that don't go to any namespace, don't have namespace name and separator prepended.</p><p>Note that moving translations to namespaces can be done gradually - messages not moved to a namespace so far will stay in shared messages.</p><h3>Split messages into multiple files</h3><p>After running <a href="https://formatjs.io/docs/getting-started/message-distribution#compiling-messages">compilation script</a> (<code>formatjs compile</code>), the compiled files (pl.json, en.json) contain all translations, including namespaced ones. Then, a custom-written Node.js script reads the compiled files, identifies what namespaces exist and what keys are in each, and writes files with namespace name prepended (or nothing prepended for shared messages):</p><pre><code>pl.json
en.json
...
mynamespace-pl.json
mynamespace-en.json
...
anothernamespace-pl.json
anothernamespace-en.json
...
...
...
</code></pre><p>The <code>[namespacename]-[languageid].json</code> files have identical format to compiled <code>[languageid].json</code>, but contain files only from a given namespace.</p><h3>Merge shared messages and namespaced translations and pass it into another IntlProvider</h3><p>Because <code>useIntl</code> hook returns current locale and all available messages, it's possible to get the shared messages and locale from there, and pass them (with namespaced messages added) to another <code>IntlProvider</code>. Then, every component inside the new <code>IntlProvider</code> will use the new, larger translations set.</p><p>A component that provides namespaced translations to its children could look like that:</p><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> translationsPL <span class="token keyword">from</span> <span class="token string">"../locales/compiled/mynamespace-pl.json"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> translationsEN <span class="token keyword">from</span> <span class="token string">"../locales/compiled/mynamespace-en.json"</span><span class="token punctuation">;</span><br><span class="token comment">// ... other languages ...</span><br><br><span class="token keyword">const</span> <span class="token function function-variable">MyNamespaceTranslationsProvider</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> children<span class="token punctuation">,</span> translations <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span><br>  <span class="token keyword">const</span> <span class="token punctuation">{</span> locale<span class="token punctuation">,</span> messages<span class="token operator">:</span> commonMessages <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useIntl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &lt;- imports messages from the upper IntlProvider</span><br><br>  <span class="token keyword">const</span> allMessages <span class="token operator">=</span> <span class="token function">useMemo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>    <span class="token keyword">let</span> namespacedMessages <span class="token operator">=</span> translationsPL<span class="token punctuation">;</span><br>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>locale<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">case</span> <span class="token string">"pl"</span><span class="token operator">:</span><br>        namespacedMessages <span class="token operator">=</span> translationsPL<span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>      <span class="token keyword">case</span> <span class="token string">"en"</span><span class="token operator">:</span><br>        namespacedMessages <span class="token operator">=</span> translationsEN<span class="token punctuation">;</span><br>        <span class="token keyword">break</span><span class="token punctuation">;</span><br>      <span class="token comment">// ... other languages ...</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token comment">// Merge messages from the upper IntlProvider with locally imported one</span><br>    <span class="token keyword">return</span> <span class="token punctuation">{</span> <span class="token operator">...</span>commonMessages<span class="token punctuation">,</span> <span class="token operator">...</span>namespacedMessages <span class="token punctuation">}</span><span class="token punctuation">;</span> <br>  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>locale<span class="token punctuation">,</span> commonMessages<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>  <span class="token comment">// Provide merged messages to the components inside</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">IntlProvider</span></span> <span class="token attr-name">locale</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>locale<span class="token punctuation">}</span></span> <span class="token attr-name">messages</span><span class="token language-javascript script"><span class="token punctuation script-punctuation">=</span><span class="token punctuation">{</span>allMessages<span class="token punctuation">}</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span>children<span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">IntlProvider</span></span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></code></pre><p>Then, it can be used e.g. on a file in <code>src/pages/pageName.tsx</code>:</p><pre class="language-tsx"><code class="language-tsx"><span class="token keyword">import</span> NamespacedTranslationsProvider <span class="token keyword">from</span> <span class="token string">"../../components-v2/NamespacedTranslationsProvider"</span><span class="token punctuation">;</span><br><span class="token comment">// ... other imports</span><br><br><span class="token keyword">const</span> <span class="token function function-variable">SomePage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span><br>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">MyNamespaceTranslationsProvider</span></span><span class="token punctuation">></span></span><span class="token plain-text"><br>      </span><span class="token punctuation">{</span><span class="token comment">/* .... other content .... */</span><span class="token punctuation">}</span><span class="token plain-text"><br>    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token class-name">MyNamespaceTranslationsProvider</span></span><span class="token punctuation">></span></span><br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">export</span> <span class="token keyword">default</span> SomePage<span class="token punctuation">;</span></code></pre><h2>Results</h2><p>How much it's going to help? It very much depends on size of translations on your site, how many languages you support, and how many messages can be moved to their namespaces.</p><p>In my case, moving content of several pages to namespaces (not all of them, we can move more texts) decreased <code>_app.tsx</code> size by tens of kB.</p><a href="/">Go back to home page</a></article><link href="/styles/prism-atom-dark.css" rel="stylesheet"><footer><div class="footer-content"><a href="https://www.radcode.co/">Do you need an app?</a></div></footer></body></html>